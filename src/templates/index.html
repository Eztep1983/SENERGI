<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SolarNari√±o - Calculadora Solar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="{{ url_for('static', filename='SENERGI.png') }}" alt="Mi imagen" width="200">            
    <p>Calculadora Solar Inteligente para el Departamento de Nari√±o</p>
        </div>

        <div class="main-content">
            <div class="search-section">
                <h3 class="section-title">B√∫squeda de Ubicaci√≥n</h3>
                
                <div class="input-group">
                    <label for="search">Buscar barrio, pueblo o ciudad:</label>
                    <input type="text" id="search" placeholder="Ejemplo: Barrio San Juan, Pasto" />
                </div>

                <button type="button" class="search-button" onclick="buscarLugar()">
                    üîç Buscar Ubicaci√≥n
                </button>

                <div class="error-message" id="search-error"></div>
                <div class="success-message" id="search-success"></div>

                <div class="input-group" style="margin-top: 20px;">
                    <label for="resultados">Resultados de b√∫squeda:</label>
                    <select id="resultados" size="5" onchange="seleccionarLugar()"></select>
                </div>
            </div>

            <div class="map-section">
                <h3 class="section-title">Selecci√≥n en Mapa</h3>
                <div id="map"></div>
                <p style="font-size: 0.9rem; color: #7f8c8d; text-align: center;">
                    Haz clic en el mapa para seleccionar una ubicaci√≥n
                </p>
                
                <div id="selected-location" class="selected-location" style="display: none;">
                    <h4>üìç Ubicaci√≥n Seleccionada</h4>
                    <p id="location-coords"></p>
                    <p id="location-address">Cargando direcci√≥n...</p>
                </div>
            </div>

            <div class="calculator-form">
                <h3 class="section-title">üßÆ Calculadora Solar</h3>
                
                <form id="solar-form">
                    <input type="hidden" id="lat" name="lat" required>
                    <input type="hidden" id="lon" name="lon" required>

                    <div class="form-grid">
                        <div class="input-group">
                            <label for="consumo">üí° Consumo mensual (kWh):</label>
                            <input type="number" id="consumo" name="consumo" min="1" step="0.1" required 
                                   placeholder="Ej: 150">
                        </div>

                        <div class="input-group">
                            <label for="costo">üí∞ Costo de instalaci√≥n (COP):</label>
                            <input type="number" id="costo" name="costo" min="1" step="1000" required 
                                   placeholder="Ej: 15000000">
                        </div>

                        <div class="input-group">
                            <label for="superficie">üìê Superficie disponible (m¬≤):</label>
                            <input type="number" id="superficie" name="superficie" min="1" step="0.1" 
                                   value="10" placeholder="Ej: 10">
                        </div>

                        <div class="input-group">
                            <label for="tarifa">‚ö° Tarifa el√©ctrica (COP/kWh):</label>
                            <input type="number" id="tarifa" name="tarifa" min="1" step="10" 
                                   value="600" placeholder="Ej: 600">
                        </div>
                    </div>

                    <button type="submit" class="calculate-button" id="calculate-btn" disabled>
                        ‚ö° Calcular Potencial Solar
                    </button>
                </form>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Calculando datos solares...</p>
                </div>

                <div class="error-message" id="calc-error"></div>
            </div>

            <div id="results" class="results" style="display: none;">
                <h2>üìä Resultados del An√°lisis Solar</h2>
                <div class="results-grid">
                    <div class="result-card">
                        <div class="icon">üåû</div>
                        <div class="value" id="generacion-value">0</div>
                        <div class="label">kWh generados por mes</div>
                    </div>
                    <div class="result-card">
                        <div class="icon">üí∏</div>
                        <div class="value" id="ahorro-value">$0</div>
                        <div class="label">Ahorro mensual estimado</div>
                    </div>
                    <div class="result-card">
                        <div class="icon">‚è∞</div>
                        <div class="value" id="roi-value">0</div>
                        <div class="label">A√±os para recuperar inversi√≥n</div>
                    </div>
                    <div class="result-card">
                        <div class="icon">üå±</div>
                        <div class="value" id="co2-value">0</div>
                        <div class="label">kg CO¬≤ evitados/a√±o</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        let map;
        let marker;
        let selectedLat = null;
        let selectedLon = null;

        // Inicializar el mapa
        function initMap() {
            // Centrar en Nari√±o, Colombia
            map = L.map('map').setView([1.2136, -77.2811], 8);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Evento de clic en el mapa
            map.on('click', function(e) {
                const lat = e.latlng.lat;
                const lon = e.latlng.lng;
                seleccionarUbicacionMapa(lat, lon);
            });
        }

        // Seleccionar ubicaci√≥n desde el mapa
        async function seleccionarUbicacionMapa(lat, lon) {
            selectedLat = lat;
            selectedLon = lon;
            
            // Actualizar campos ocultos
            document.getElementById('lat').value = lat;
            document.getElementById('lon').value = lon;
            
            // Agregar/actualizar marcador
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker([lat, lon]).addTo(map);
            
            // Mostrar informaci√≥n de ubicaci√≥n
            const locationDiv = document.getElementById('selected-location');
            const coordsP = document.getElementById('location-coords');
            const addressP = document.getElementById('location-address');
            
            coordsP.textContent = `Coordenadas: ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
            addressP.textContent = 'Cargando direcci√≥n...';
            locationDiv.style.display = 'block';
            
            // Obtener direcci√≥n usando geocodificaci√≥n inversa
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&addressdetails=1&accept-language=es`
                );
                const data = await response.json();
                addressP.textContent = data.display_name || 'Direcci√≥n no disponible';
            } catch (error) {
                addressP.textContent = 'Error al obtener direcci√≥n';
            }
            
            // Habilitar bot√≥n de c√°lculo
            updateCalculateButton();
            showSuccessMessage('search-success', '‚úÖ Ubicaci√≥n seleccionada correctamente');
        }

        // Buscar lugar
        async function buscarLugar() {
            const query = document.getElementById('search').value.trim();
            const resultados = document.getElementById('resultados');
            
            hideMessages();
            resultados.innerHTML = '';
            
            if (!query) {
                showErrorMessage('search-error', 'Por favor ingresa un lugar para buscar.');
                return;
            }

            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query + ', Nari√±o, Colombia')}&format=json&addressdetails=1&limit=10&countrycodes=co`;

            try {
                const response = await fetch(url, { 
                    headers: { 'Accept-Language': 'es' } 
                });
                const data = await response.json();

                if (data.length === 0) {
                    resultados.innerHTML = '<option>No se encontraron resultados</option>';
                    showErrorMessage('search-error', 'No se encontraron resultados para tu b√∫squeda.');
                    return;
                }

                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = `${item.lat},${item.lon}`;
                    option.textContent = item.display_name;
                    resultados.appendChild(option);
                });

                showSuccessMessage('search-success', `‚úÖ Se encontraron ${data.length} resultados`);
            } catch (error) {
                showErrorMessage('search-error', 'Error al buscar el lugar. Verifica tu conexi√≥n e intenta de nuevo.');
                console.error(error);
            }
        }

        // Seleccionar lugar de la lista
        function seleccionarLugar() {
            const resultados = document.getElementById('resultados');
            const seleccionado = resultados.options[resultados.selectedIndex];
            
            if (seleccionado && seleccionado.value) {
                const [lat, lon] = seleccionado.value.split(',');
                seleccionarUbicacionMapa(parseFloat(lat), parseFloat(lon));
                
                // Centrar mapa en la ubicaci√≥n seleccionada
                map.setView([parseFloat(lat), parseFloat(lon)], 14);
            }
        }

        // Actualizar estado del bot√≥n de c√°lculo
        function updateCalculateButton() {
            const btn = document.getElementById('calculate-btn');
            const lat = document.getElementById('lat').value;
            const lon = document.getElementById('lon').value;
            
            btn.disabled = !lat || !lon;
        }

        // Manejar env√≠o del formulario
        document.getElementById('solar-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const calcError = document.getElementById('calc-error');
            
            // Mostrar loading
            loading.style.display = 'block';
            results.style.display = 'none';
            calcError.style.display = 'none';
            
            try {
                const formData = new FormData(this);
                const data = Object.fromEntries(formData);
                
                // Simular c√°lculo (aqu√≠ ir√≠a la llamada a tu API)
                await calcularDatosSolares(data);
                
            } catch (error) {
                showErrorMessage('calc-error', 'Error al calcular los datos solares. Intenta de nuevo.');
                console.error(error);
            } finally {
                loading.style.display = 'none';
            }
        });

        // Funci√≥n de c√°lculo solar (simulada)
        async function calcularDatosSolares(data) {
            // Simular delay de API
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const lat = parseFloat(data.lat);
            const lon = parseFloat(data.lon);
            const consumo = parseFloat(data.consumo);
            const costo = parseFloat(data.costo);
            const superficie = parseFloat(data.superficie) || 10;
            const tarifa = parseFloat(data.tarifa) || 600;
            
            // C√°lculos simplificados (en producci√≥n usar√≠as NASA POWER API)
            const radiacionPromedio = 4.5; // kWh/m¬≤/d√≠a (promedio para Nari√±o)
            const eficienciasistema = 0.75;
            const generacionMensual = radiacionPromedio * eficienciasistema * superficie * 30;
            
            const ahorroMensual = Math.min(generacionMensual, consumo) * tarifa;
            const ahorroAnual = ahorroMensual * 12;
            const roi = costo / ahorroAnual;
            const co2Evitado = generacionMensual * 12 * 0.5; // kg CO2/a√±o
            
            // Mostrar resultados
            document.getElementById('generacion-value').textContent = generacionMensual.toFixed(1);
            document.getElementById('ahorro-value').textContent = '$' + ahorroMensual.toLocaleString('es-CO');
            document.getElementById('roi-value').textContent = roi.toFixed(1);
            document.getElementById('co2-value').textContent = co2Evitado.toFixed(0);
            
            document.getElementById('results').style.display = 'block';
        }

        // Funciones auxiliares para mensajes
        function showErrorMessage(id, message) {
            const el = document.getElementById(id);
            el.textContent = message;
            el.style.display = 'block';
        }

        function showSuccessMessage(id, message) {
            const el = document.getElementById(id);
            el.textContent = message;
            el.style.display = 'block';
        }

        function hideMessages() {
            document.querySelectorAll('.error-message, .success-message').forEach(el => {
                el.style.display = 'none';
            });
        }

        // Permitir Enter para buscar
        document.getElementById('search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                buscarLugar();
            }
        });

        // Inicializar mapa cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
        });
    </script>
</body>
</html>